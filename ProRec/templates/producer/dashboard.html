{% extends 'base.html' %}
{% block title %}Dashboard Produtor - ProRec{% endblock %}
{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8" x-data="producerDashboard()" x-init="init()">
<h1 class="text-2xl font-bold mb-6">Dashboard do Produtor</h1>
<div class="mb-6">
<nav class="flex space-x-2 bg-gray-100 p-1 rounded-lg">
<button @click="tab='history'" :class="tab=='history'?'bg-white text-gray-900 shadow':'text-gray-600 hover:text-gray-900'" class="flex-1 py-3 px-4 rounded-md font-medium text-sm transition-all">O que já fiz</button>
<button @click="tab='publish'" :class="tab=='publish'?'bg-white text-gray-900 shadow':'text-gray-600 hover:text-gray-900'" class="flex-1 py-3 px-4 rounded-md font-medium text-sm transition-all">O que posso fazer</button>
<button @click="tab='map'" :class="tab=='map'?'bg-white text-gray-900 shadow':'text-gray-600 hover:text-gray-900'" class="flex-1 py-3 px-4 rounded-md font-medium text-sm transition-all">O que está acontecendo</button>
</nav>
</div>
<div x-show="tab=='history'" x-cloak>
<div class="grid grid-cols-3 gap-6 mb-6">
<div class="bg-white rounded-lg shadow p-6"><p class="text-sm text-gray-600">Pontos Totais</p><p class="text-3xl font-bold text-yellow-600" x-text="stats.points">0</p></div>
<div class="bg-white rounded-lg shadow p-6"><p class="text-sm text-gray-600">Coletas Realizadas</p><p class="text-3xl font-bold" x-text="stats.collections_completed">0</p></div>
<div class="bg-white rounded-lg shadow p-6"><p class="text-sm text-gray-600">Conquistas Desbloqueadas</p><p class="text-3xl font-bold" x-text="stats.achievements_unlocked + '/' + stats.achievements_total">0/0</p></div>
</div>
<div class="bg-white rounded-lg shadow p-6 mb-6">
<h2 class="text-lg font-semibold mb-4">Conquistas</h2>
<div class="grid grid-cols-2 md:grid-cols-4 gap-4">
<template x-for="achievement in achievements" :key="achievement.id">
<div :class="achievement.unlocked ? 'bg-green-600 text-white' : 'bg-gray-50 border-2 border-gray-200 opacity-60'" class="rounded-lg p-4 text-center">
<div class="text-4xl mb-2" :class="!achievement.unlocked && 'grayscale'" x-text="achievement.icon"></div>
<p class="font-semibold text-sm" :class="achievement.unlocked ? '' : 'text-gray-600'" x-text="achievement.name"></p>
<p class="text-xs mt-1" :class="achievement.unlocked ? 'opacity-90' : 'text-gray-500'" x-text="achievement.unlocked ? 'Desbloqueada!' : 'Faltam ' + achievement.points_remaining + ' pontos'"></p>
</div>
</template>
</div>
</div>
<div class="bg-white rounded-lg shadow">
<div class="p-6 border-b">
<h2 class="text-lg font-semibold">Histórico de Coletas</h2>
</div>
<div class="divide-y divide-gray-200">
<template x-if="collections.length === 0">
<div class="p-6 text-center text-gray-500">
<p>Nenhuma coleta realizada ainda.</p>
</div>
</template>
<template x-for="collection in collections" :key="collection.id">
<div class="p-6">
<div class="flex items-start justify-between">
<div class="flex-1">
<h3 class="font-semibold text-gray-900" x-text="collection.material_name"></h3>
<div class="flex items-center gap-3 mt-2">
<span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium bg-blue-100 text-blue-800" x-text="collection.category"></span>
<span class="text-sm text-gray-600" x-text="collection.quantity" x-show="collection.quantity"></span>
<span class="text-sm text-gray-500" x-text="collection.date"></span>
</div>
<p class="text-sm text-gray-600 mt-2" x-show="collection.feedback" x-text="'Feedback: ' + collection.feedback"></p>
</div>
<span class="text-yellow-600 font-bold text-lg" x-text="'+' + collection.points + ' pts'"></span>
</div>
</div>
</template>
</div>
</div>
</div>
<div x-show="tab=='publish'" x-cloak>
<div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
<div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-4">
<div>
<h2 class="text-lg font-semibold text-gray-900">Publicar Novo Resíduo</h2>
<p class="text-sm text-gray-600 mt-1">Cadastre um material para coleta e aguarde aprovação da curadoria</p>
</div>
<button @click="showForm = !showForm" type="button" class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors whitespace-nowrap">
<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
</svg>
Adicionar Novo Material
</button>
</div>
<form x-show="showForm" @submit.prevent="submitMaterial" class="space-y-4 pt-4 border-t border-gray-200" x-cloak>
<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">Nome do Resíduo</label>
<input x-model="formData.name" type="text" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
<select x-model="formData.category" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
<option value="">Selecione uma categoria</option>
<option value="plastico">Plástico</option>
<option value="vidro">Vidro</option>
<option value="papel">Papel</option>
<option value="metal">Metal</option>
<option value="eletronicos">Eletrônicos</option>
<option value="organico">Orgânico</option>
</select>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">Descrição</label>
<textarea x-model="formData.description" rows="3" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"></textarea>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1">Localização</label>
<input x-model="formData.location" type="text" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
</div>
<div class="flex gap-3 pt-2">
<button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
Publicar
</button>
<button @click="showForm = false; resetForm()" type="button" class="px-4 py-2 border border-gray-300 bg-white text-gray-700 rounded-md hover:bg-gray-50 transition-colors">
Cancelar
</button>
</div>
</form>
</div>

<div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
<div class="mb-6">
<h2 class="text-lg font-semibold text-gray-900">Materiais Publicados</h2>
<p class="text-sm text-gray-600 mt-1">Acompanhe o status dos seus materiais</p>
</div>
<div class="space-y-4">
<template x-for="material in publishedItems" :key="material.id">
<div class="bg-white border rounded-lg p-4 hover:shadow-md transition-shadow" :class="material.status === 'pending' ? 'border-yellow-600 bg-yellow-50' : material.status === 'approved' ? 'border-green-600 bg-green-50' : 'border-red-600 bg-red-50'">
<div class="flex items-start justify-between mb-3">
<div class="flex-1">
<h3 class="font-semibold text-gray-900" x-text="material.name"></h3>
<div class="flex items-center gap-2 mt-2 flex-wrap">
<span class="inline-flex items-center px-2 py-1 text-xs font-medium bg-white border border-gray-300 rounded-md text-gray-700" x-text="material.category"></span>
<span x-show="material.status === 'pending'" class="inline-flex items-center px-2 py-1 text-xs font-medium border-2 border-yellow-600 text-yellow-700 bg-yellow-100 rounded-md">
<svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
</svg>
Aguardando curadoria
</span>
<span x-show="material.status === 'approved'" class="inline-flex items-center px-2 py-1 text-xs font-medium bg-green-600 text-white rounded-md">
<svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
</svg>
Aprovado
</span>
<span x-show="material.status === 'rejected'" class="inline-flex items-center px-2 py-1 text-xs font-medium border-2 border-red-600 text-red-700 bg-red-100 rounded-md">
<svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
</svg>
Reprovado
</span>
</div>
</div>
<span class="text-xs text-gray-500" x-text="material.date"></span>
</div>
<p class="text-sm text-gray-700 mb-2" x-text="material.description"></p>
<div class="flex items-center text-sm text-gray-600">
<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
</svg>
<span x-text="material.location"></span>
</div>
<div x-show="material.feedback" class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-md">
<p class="text-sm font-medium text-blue-900">Feedback do Curador:</p>
<p class="text-sm text-blue-800 mt-1" x-text="material.feedback"></p>
</div>
</div>
</template>
</div>
</div>

<div class="bg-white border border-gray-200 rounded-lg p-6">
<div class="mb-6">
<h2 class="text-lg font-semibold text-gray-900">Pontos de Coleta Próximos</h2>
<p class="text-sm text-gray-600 mt-1">Locais onde você pode levar seus materiais</p>
</div>
<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
<template x-for="point in collectionPoints" :key="point.id">
<div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
<h3 class="font-semibold text-gray-900 mb-3" x-text="point.name"></h3>
<div class="space-y-2 text-sm text-gray-600 mb-4">
<div class="flex items-start">
<svg class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
</svg>
<span x-text="point.address"></span>
</div>
<div class="flex items-center">
<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
</svg>
<span x-text="point.hours"></span>
</div>
<span class="inline-flex items-center px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-md" x-text="point.distance"></span>
</div>
<button type="button" class="w-full px-3 py-2 border border-gray-300 bg-white text-gray-700 rounded-md hover:bg-gray-50 transition-colors text-sm font-medium">
Ver no Mapa
</button>
</div>
</template>
</div>
</div>
</div>
<div x-show="tab=='map'" x-cloak>
<div class="bg-white rounded-lg shadow p-6 mb-6">
<h2 class="text-lg font-semibold mb-4">Mapa de Pontos de Coleta e Eventos</h2>
<div class="bg-gradient-to-br from-green-100 to-green-200 rounded-lg h-96 flex flex-col items-center justify-center relative overflow-hidden">
<div class="absolute inset-0 opacity-20">
<div class="absolute top-20 left-20 w-4 h-4 bg-green-600 rounded-full animate-pulse"></div>
<div class="absolute top-40 right-32 w-4 h-4 bg-green-600 rounded-full animate-pulse delay-100"></div>
<div class="absolute bottom-32 left-40 w-4 h-4 bg-green-600 rounded-full animate-pulse delay-200"></div>
</div>
<svg class="w-16 h-16 text-green-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
</svg>
<p class="text-gray-700 font-medium">Mapa Interativo</p>
<p class="text-gray-600 text-sm mt-1">Em desenvolvimento - Integração com mapa interativo</p>
</div>
</div>
<div class="bg-white rounded-lg shadow">
<div class="p-6 border-b">
<h2 class="text-lg font-semibold">Eventos Acontecendo Hoje</h2>
</div>
<div class="divide-y divide-gray-200">
<template x-if="eventsToday.length === 0">
<div class="p-6 text-center text-gray-500">
<p>Nenhum evento programado para hoje.</p>
</div>
</template>
<template x-for="event in eventsToday" :key="event.id">
<div class="p-6">
<div class="flex items-start justify-between">
<div class="flex-1">
<h3 class="font-semibold text-gray-900" x-text="event.title"></h3>
<div class="flex items-center gap-4 mt-2 text-sm text-gray-600">
<div class="flex items-center">
<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
</svg>
<span x-text="event.location"></span>
</div>
<div class="flex items-center" x-show="event.time">
<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
</svg>
<span x-text="event.time"></span>
</div>
<span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-md"
      :class="event.type === 'coleta' ? 'bg-blue-100 text-blue-800' : event.type === 'workshop' ? 'bg-purple-100 text-purple-800' : 'bg-green-100 text-green-800'"
      x-text="event.type_display"></span>
</div>
</div>
<span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium"
      :class="event.status === 'em_andamento' ? 'bg-green-600 text-white' : 'border border-blue-600 text-blue-600'"
      x-text="event.status_display"></span>
</div>
</div>
</template>
</div>
</div>
</div>
</div>
<script>
function producerDashboard() {
  return {
    tab: 'history',
    showForm: false,
    loading: true,
    formData: {
      name: '',
      category: '',
      description: '',
      location: ''
    },
    stats: {
      points: 0,
      collections_completed: 0,
      achievements_unlocked: 0,
      achievements_total: 0
    },
    achievements: [],
    collections: [],
    publishedItems: [],
    collectionPoints: [],
    eventsToday: [],

    async init() {
      await Promise.all([
        this.loadStats(),
        this.loadAchievements(),
        this.loadCollections(),
        this.loadMaterials(),
        this.loadCollectionPoints(),
        this.loadEventsToday()
      ]);
      this.loading = false;
    },

    async loadStats() {
      try {
        const response = await fetch('/api/producer/stats');
        if (response.ok) {
          this.stats = await response.json();
        }
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    },

    async loadAchievements() {
      try {
        const response = await fetch('/api/producer/achievements');
        if (response.ok) {
          this.achievements = await response.json();
        }
      } catch (error) {
        console.error('Error loading achievements:', error);
      }
    },

    async loadCollections() {
      try {
        const response = await fetch('/api/producer/collections');
        if (response.ok) {
          this.collections = await response.json();
        }
      } catch (error) {
        console.error('Error loading collections:', error);
      }
    },

    async loadMaterials() {
      try {
        const response = await fetch('/api/producer/materials');
        if (response.ok) {
          this.publishedItems = await response.json();
        }
      } catch (error) {
        console.error('Error loading materials:', error);
      }
    },

    async loadCollectionPoints() {
      try {
        const response = await fetch('/api/producer/collection-points');
        if (response.ok) {
          this.collectionPoints = await response.json();
        }
      } catch (error) {
        console.error('Error loading collection points:', error);
      }
    },

    async loadEventsToday() {
      try {
        const response = await fetch('/api/producer/events/today');
        if (response.ok) {
          this.eventsToday = await response.json();
        }
      } catch (error) {
        console.error('Error loading events:', error);
      }
    },

    async submitMaterial() {
      try {
        const response = await fetch('/api/producer/materials', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
          },
          body: JSON.stringify(this.formData)
        });

        if (response.ok) {
          const newMaterial = await response.json();
          this.publishedItems.unshift(newMaterial);
          this.resetForm();
          this.showForm = false;
          alert('Material publicado com sucesso! Aguarde aprovação da curadoria.');
        } else {
          const error = await response.json();
          alert('Erro ao publicar material: ' + (error.error || 'Erro desconhecido'));
        }
      } catch (error) {
        console.error('Error submitting material:', error);
        alert('Erro ao publicar material. Tente novamente.');
      }
    },

    resetForm() {
      this.formData = {
        name: '',
        category: '',
        description: '',
        location: ''
      };
    }
  }
}
</script>
{% endblock %}
